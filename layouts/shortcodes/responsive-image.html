{{- /* Responsive Image Shortcode */ -}}
{{- $src := .Get "src" -}}
{{- $alt := .Get "alt" | default "" -}}
{{- $class := .Get "class" | default "" -}}
{{- $loading := .Get "loading" | default "lazy" -}}
{{- $width := .Get "width" -}}
{{- $height := .Get "height" -}}

{{- /* Get the image resource */ -}}
{{- $image := "" -}}
{{- if hasPrefix $src "/" -}}
  {{- $image = resources.Get (strings.TrimLeft "/" $src) -}}
{{- else -}}
  {{- $image = resources.Get $src -}}
{{- end -}}

{{- if $image -}}
  {{- /* Generate different sizes for responsive images */ -}}
  {{- $small := $image.Resize "480x" -}}
  {{- $medium := $image.Resize "768x" -}}
  {{- $large := $image.Resize "1200x" -}}
  
  <picture class="{{ $class }}">
    {{- /* WebP format for modern browsers */ -}}
    {{- if ge hugo.Version "0.83" -}}
    <source 
      srcset="{{ ($small.Process "webp").RelPermalink }} 480w,
              {{ ($medium.Process "webp").RelPermalink }} 768w,
              {{ ($large.Process "webp").RelPermalink }} 1200w"
      sizes="(max-width: 480px) 480px, (max-width: 768px) 768px, 1200px"
      type="image/webp">
    {{- end -}}
    
    {{- /* Fallback to original format */ -}}
    <img 
      src="{{ $medium.RelPermalink }}"
      srcset="{{ $small.RelPermalink }} 480w,
              {{ $medium.RelPermalink }} 768w, 
              {{ $large.RelPermalink }} 1200w"
      sizes="(max-width: 480px) 480px, (max-width: 768px) 768px, 1200px"
      alt="{{ $alt }}"
      loading="{{ $loading }}"
      {{- if $width }} width="{{ $width }}"{{ end }}
      {{- if $height }} height="{{ $height }}"{{ end }}
      class="{{ $class }}">
  </picture>
{{- else -}}
  {{- /* Fallback for external images or missing resources */ -}}
  <img 
    src="{{ $src }}"
    alt="{{ $alt }}"
    loading="{{ $loading }}"
    {{- if $width }} width="{{ $width }}"{{ end }}
    {{- if $height }} height="{{ $height }}"{{ end }}
    class="{{ $class }}">
{{- end -}}